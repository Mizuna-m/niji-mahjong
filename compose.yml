services:
  mongo:
    image: docker.io/library/mongo:7
    container_name: niji-mongo
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db

  api:
    image: docker.io/library/node:20
    container_name: niji-api
    working_dir: /app
    restart: unless-stopped
    environment:
      - PORT=3000
      - MONGO_URL=mongodb://mongo:27017/niji
      - DATA_DIR=/data
      - GIT_REPO_DIR=/repo
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=500
    volumes:
      - ./app:/app
      - ./data:/data:ro
      - ./repo:/repo
    command: ["bash", "-lc", "npm ci && node src/server.cjs"]
    depends_on:
      - mongo
    ports:
      - "3000:3000"

  web:
    image: docker.io/library/node:20
    container_name: niji-web
    working_dir: /web
    restart: unless-stopped
    environment:
      - PORT=3001
      - API_BASE_INTERNAL=http://api:3000
    volumes:
      - ./web:/web
      - web_node_modules:/web/node_modules
      - web_next_cache:/web/.next
    command: ["bash", "-lc", "npm ci --include=dev && npm run dev -- -p 3001 -H 0.0.0.0"]
    ports:
      - "3001:3001"
    depends_on:
      - api

volumes:
  mongo_data:
  web_node_modules:
  web_next_cache:
